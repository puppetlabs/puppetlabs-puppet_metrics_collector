#!/bin/bash

set -e

# Arguments and defaults.

METRICS_OUTPUT_DIR=${1:-/opt/puppetlabs/puppet-metrics-collector}
METRICS_TYPE=${2:-puppetserver}
RETENTION_DAYS=${3:-90}

METRICS_DIR="$METRICS_OUTPUT_DIR/$METRICS_TYPE"

# Guard. 

METRICS_REALPATH=$(realpath "$METRICS_DIR")
if [ "$METRICS_REALPATH" = "/" ]; then
  echo "Invalid options"
  exit 1
fi

# Delete files older than the retention period, in days.

find "$METRICS_DIR" -type f -ctime +"$RETENTION_DAYS" -delete

# Compress the remaining files.

cd "$METRICS_DIR"
find . -type f -name "*.json" > "$METRICS_DIR.tmp"
tar --create --gzip --file "$METRICS_DIR/$METRICS_TYPE-$(date +%Y.%m.%d.%H.%M.%S).tar.gz" --files-from "$METRICS_DIR.tmp"

# Delete the files that have been compressed.

xargs -r -a "$METRICS_DIR.tmp" rm
rm "$METRICS_DIR.tmp"
