#!/bin/bash

set -e

# Arguments and defaults.

METRICS_DIR=${1:-/opt/puppetlabs/puppet-metrics-collector/puppetserver}
RETENTION_DAYS=${2:-90}

METRICS_TYPE=$(basename "$METRICS_DIR")

# Guard. 

INVALID_PATHS=(/ /etc /var /opt /usr)
METRICS_REALPATH=$(realpath "$METRICS_DIR")
if [ "$METRICS_REALPATH" = "/" ]; then
  echo "Invalid options"
  exit 1
fi

# Delete metrics files older than the retention period, in days.

find "$METRICS_DIR" -type f -ctime +"$RETENTION_DAYS" -regex '\(.*gz$\|.*json$\)' -delete

# Archive the remaining metrics files.

cd "$METRICS_DIR"
find . -type f -name "*.json" > "$METRICS_DIR.tmp"
tar --create --gzip --file "$METRICS_DIR/$METRICS_TYPE-$(date +%Y.%m.%d.%H.%M.%S).tar.gz" --files-from "$METRICS_DIR.tmp"

# Delete the files that have been compressed.

xargs -r -a "$METRICS_DIR.tmp" rm
rm "$METRICS_DIR.tmp"
